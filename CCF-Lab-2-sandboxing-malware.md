# CCF Lab 2 Sandboxing

Artem Abramov



## 1. Preparation:

a. Prepare a sandboxing solution that you would like to try, for example  Cuckoo .

b. Use any virtualization environment, please make sure to download the latest version (check
repo and official website).

c. Create a VM with your sandboxing solution, and make sure that it uses a  HOST ONLY network adapter.



Create VirtualBox with Ubuntu guest. Give him two network adapters

- Host-Only will be used to communicate between cuckoo server and cuckoo client inside VM
- bridged to allow to install Cuckoo on the VM, after install it must be disabled in VirtualBox.



Install cuckoo dependencies: https://cuckoo.sh/docs/installation/host/index.html

Note: Cuckoo requires Python 2.7

Note: Create and activate python virtual environment which is shown in the instructions below, then install cuckoo!

Install cuckoo: https://cuckoo.sh/docs/installation/host/installation.html

Check that it runs:

```
# cuckoo -d

                      __
  .----..--.--..----.|  |--..-----..-----.
  |  __||  |  ||  __||    < |  _  ||  _  |
  |____||_____||____||__|__||_____||_____|

 Cuckoo Sandbox 2.0.7
 www.cuckoosandbox.org
 Copyright (c) 2010-2018

=======================================================================
    Welcome to Cuckoo Sandbox, this appears to be your first run!
    We will now set you up with our default configuration.
    You will be able to see and modify the Cuckoo configuration,
    Yara rules, Cuckoo Signatures, and much more to your likings
    by exploring the /home/artem/.cuckoo directory.

    Among other configurable items of most interest is the
    new location for your Cuckoo configuration:
              /home/artem/.cuckoo/conf
=======================================================================

Cuckoo has finished setting up the default configuration.
Please modify the default settings where required and
start Cuckoo again (by running `cuckoo` or `cuckoo -d`).
```



**Config host**

cuckoo.conf - already ready for VirtualBox (i.e. the ip is set to 192.168.56.1, machinery = virtualbox).

auxiliary.conf - already ready

virtualbox.conf - almost ready for VirtualBox (i.e. network interface = vboxnet0, machine ip = 192.168.56.101), but must specify the platform and tag name for machine (one of results from `VBoxManage list vms
`) as below:

```
[virtualbox]
machines = sandbox-1

[sandbox-1]
label = sandbox-1
platform = linux
```

memory.conf - already ready

processing.conf - already ready

reporting.conf - enable creation of single HTML report and mongodb connection (for web-interface):

```
[singlefile]
enabled = yes
html = yes
[mongodb]
enabled = yes
```

Download cuckoo signatures and Yara rules by running:

```
# cuckoo community
```




**Config guest**

See: https://cuckoo.sh/docs/installation/guest/linux.html

In case of VirtualBox with vboxnet0 adapter, there is nothing more to configure for network.

Transfer the ~/.cuckoo/agent/agent.py into the guest machine via python3 http.server (in ~/.cuckoo/agent).

Actually make a snapshot of the guest.



**Back on the host**

Start the daemon and web interface:

```
cuckoo -d
cuckoo web runserver
```


## 2. Let’s get some malware:
**a. Download some malware/ransomware from the internet (for example  TheZoo ), also you can check your Email for any spam with attachment, Please be careful when you run them,  THESE ARE REAL MALWARE .**

Interesting reading:

- The Art of Computer Virus Research and Defense by Peter Szor
- https://github.com/rshipp/awesome-malware-analysis - repo with links to other resources



More or less detailed descriptions of various malware (threat database):

- https://www.f-secure.com/v-descs/index.shtml

- https://www.trendmicro.com/vinfo/us/threat-encyclopedia/malware



Well organized repositories with malware binaries/source. 

- https://github.com/ytisf/theZoo - Live samples with binaries and source code.
- https://github.com/RamadhanAmizudin/malware - A lot of source code for known malware.



Less organised:

- http://vxvault.net/ViriList.php - registration required 
- https://www.virustotal.com - registration required



**b. Select at least two malware that you want to analyse in the sandbox VM that you prepared in step 1.**

I choose the following linux malware binaries from the Zoo project:

- Linux.Snoopy.C - extracts to file named X23 

- Linux.Chapros.A - extracts to file named linux-chapros_E022DE72CCE8129BD5AC8A0675996318

- JS.JScript.A - extracts to HTML.Jsv.b.HTM

- JS.Lame - extract to HTML.Lame.HTM

    

## 3. Sandbox Analysis:

**a. See what kind of traces, artifact, connection does your sandbox VM manage to detect.**

It turns out that Cuckoo is still in beta stage with regard of analyzing linux ELF files. (source: https://github.com/cuckoosandbox/cuckoo/issues/1455) So the results were useless as shown in the screenshots below. I have tried multiple things to get cuckoo to produce some meaningful results, including:

- compiling patched strace module to log system calls
- different cuckoo versions
- using custom plans for analyzing ELF 

However at least with the two binaries below I was not able to get it working.



The result for the Linux.Snoopy.C malware that supposedly infects binaries in reachable directories:

![](CCF-Lab-2-sandboxing-malware.assets/Screenshot%20from%202020-04-21%2023-04-38.png)



Result of analysing Linux.Chapros.A is shown below (same 0 out of 10):

![](CCF-Lab-2-sandboxing-malware.assets/Screenshot%20from%202020-04-21%2023-16-15.png) 



Failing with elf files I tried to analyse something cross platform such as Javascript. However it turns out that cuckoo is really focused on using the windows and using Internet Explorer. Trying to analyse this Javascript I was getting failures as shown below (the agent inside the machine was crushing because it could not run Internet Explorer):

![](CCF-Lab-2-sandboxing-malware.assets/Screenshot%20from%202020-04-21%2023-41-11.png)



The conclusion is that Cuckoo is really oriented towards a Windows guest, I wanted to analyses infected EFL files and had setup a Linux guest, but by the time it became clear that cuckoo was Windows oriented it was too late to change my setup, so I just tried to do as much of the lab as possible.



**b. Try to analyze the behavior of the malware, and try to write about what the malware does and what is the goal of the malware.**

It was not possible to make any deductions based on the cuckoo analysis.



**c. Does the malware have some sandbox detection? If yes try to defeat/detect the techniques that are used for that.**

This is not possible to say based on results from cuckoo. However this is some relatively old malware, so I suspect that it does not employ sophisticated evasion techniques.



**d. Try to use other online tools (for example ​ any.run​ , ​ hybrid analysis​ , ... ), see if these online platforms will manage to detect more artifacts than what you have found.**

Running the binaries through multiple online tools correctly revealed the malware. Result of using https://www.hybrid-analysis.com/ for Linux.Snoopy.C is shown below:

![](CCF-Lab-2-sandboxing-malware.assets/Screenshot%20from%202020-04-21%2022-46-05.png)



Result of running Linux.Snoopy.C  through VirusTotal:

![](CCF-Lab-2-sandboxing-malware.assets/Screenshot%20from%202020-04-21%2023-46-52.png)



Running the JS.Lame through hybrid-analysis is shown below (testing on Windows):

![](CCF-Lab-2-sandboxing-malware.assets/Screenshot%20from%202020-04-21%2023-49-55.png)

Running JS.Script.A through hybrid-analysis is shown below (testing on **Linux**) the script is correctly recognized as malicious:

![](CCF-Lab-2-sandboxing-malware.assets/Screenshot%20from%202020-04-21%2023-54-32.png)



Other testing sites:

- https://any.run/

- https://github.com/drbeni/malquarium (self-hosted, runs a few analysers against uploaded files)





## 4. Static Analysis:

**a. Use any tool for static analysis (for example IDA, Binary Ninja, Hopper, Radare2, ...)**

Interesting approaches discussed in:

- https://www.malwaretech.com/
- http://contagiodump.blogspot.com/

I looked at Javascript malware.

JS.Script.A by static analysis: is a trojan program that is meant to hang the browser indefinately, either by opening an infinite number of browser windows or by staying in an infinite loop. This of couuser works only in older browsers such as Internet Explorer.

JS.Lame by static analysis: Basically once every N days it would replace the HTML you were viewing with a specifically crafted header. The version I had also tried to change background image in IE.



**b. Try to see if there are some artifacts that dynamic analysis did not manage to find, for example a peace of code that did not run inside the sandbox VM.**

For the Javascript code, Internet Explorer was required to execute it, so it actually crushed the cuckoo agent on the linux host. 



The Linux.Snoopy.C binary had mutex calls (i.e. forking behaiviour) that did not seem to run inside the VM. 



**c. Try to describe which method is better (Sandboxing V.S static analysis) is better, and which one is more useful in which case.**

Static analysis seems to be the way to go when using linux, because the tools for automated analysis are simply not ready. During this lab I had difficulties finding infected ELF executables, i.e. the malware corpora for linux is either not published, or harder to access for whatever other reason. Another reason why automated analysis for Linux is lagging behind, I guess would be that linux users are more tech-savy and malware authors put more effort into hiding the traces in the system. 




## 5. Dynamic Analysis (Optional):
a. Try to use some debugger to analyse the malware WHILE IT IS RUNNING , be careful where you will run that malware, the debugger that you select must have a remote debugging feature.

b. Try some debugger that will allow you to debug the whole operation system (for example
PyReBox).

c. What kind of benefit does this method have?
